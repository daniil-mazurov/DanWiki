# Описание процесса тестирования 

|                                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| pytest test_1.py                     | Запуск простого тестирования в КС                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| pytest -v test_1.py                  | Более развернутое описание тестирования                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
|                                      | - Тестовые файлы должны быть названы test_<something>.py или <something>_test.py. <br>    <br><br>- Методы и функции тестирования должны быть названы test_<something>. <br>    <br><br>- Тестовые классы должны быть названы Test<Something>.                                                                                                                                                                                                                                                                     |
| `assert X1==X2`                      | Указывается в тестовых функциях как ключевое условие, которое нужно проверить                                                                                                                                                                                                                                                                                                                                                                                                                                      |
|                                      | PASSED (.): Тест выполнен успешно. <br><br>FAILED (F): Тест не выполнен успешно (или XPASS + strict). <br><br>SKIPPED (s): Тест был пропущен.  <br><br>xfail (x): Тест не должен был пройти, был запущен и провалился.  <br><br>XPASS (X): Тест не должен был пройти, был запущен и прошел!.. <br><br>ERROR (E): Исключение произошло за пределами функции тестирования, либо в фикстуре, обсуждается в главе 3, pytest Фикстуры, на стр. 49, или в hook function, обсуждается в главе 5, Плагины, на странице 95. |
| pytest folder\folder                 | Запуск всех тестовых функций из директории folder\folder…                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| pytest test_1.py::test_???           | Запуск конкретной тестовой функции test_??? в файле test_1.py                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| pytest test_1.py::Test_???           | Запуск тестового класса Test_??? в файле test_1.py                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| pytest test_1.py::Test_???::test_??? | Запуск конкретной тестовой функции test_??? в тестовом классе Test_???  в файле test_1.py                                                                                                                                                                                                                                                                                                                                                                                                                          |

# Флаги 

|   |   |
|---|---|
|--collect-only|Параметр --collect-only показывает, какие тесты будут выполняться с заданными параметрами и конфигурацией.|
|-k “expr”|Позволяет провести тестирование функций, удовлетворяющих выражению expr, например pytest -k "asdict or defaults" проверит две функции. <br><br>Например, мы также можем запустить все функции с именем включающим expr (в этом случае кавычки не нужны)|
|-x|Остановить тестирование при появлении ошибки (--maxfail=num, где num – количество ошибок для остановки тестирования)|
|--tb=no|Отключить описание ошибок|
|--tb=line|Построчный вывод ошибок|
|-s|Включает вывод данных (например, print), который есть в функциях в сводку тестирования|
|--lf|Запуск проваленных тестов при последнем тестировании|
|--ff|Аналогично --lf, но после выполняются все оставшиеся тесты|
|-q|Сокращает информацию о результатах тестирования|
|--durations=N|Показывает N самых медленных тестов|
|-rs|Показывает дополнительную сводную информацию по тесту, обозначенному символами в отдельном блоке. <br><br>    (f)ailed, (E)error, (s)skipped, (x)failed, (X)passed, <br><br>    (p)passed, (P)passed with output, (a)all except pP.|
|--setup-show|Добавляет в сводку тестирования сведения об использованных фикстурах.|
|--fixtures|Выводит в сводку тестирования все фикстуры, доступные для теста, в том числе те, которые были переименованы.|
|--cache-show|Показывает информацию об ошибках и удачно выполненных тестах теста из последнего тестового сеанса.|
|--clear-cache|Очистка кэша.|

# Маркеры 

|                                                           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| --------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| -m “marker_name”                                          | Запуск тестов, помеченных декоратором  <br><br>`@pytest.mark. marker_name `<br><br>Выражение после -m может использовать `and`, `or` и `not` комбинировать несколько маркеров: <br><br>`and` – тесты где есть оба маркера <br><br>`or` –  <br><br>`not name` – где нет маркера name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| skip(), skipif()                                          | Если в декораторе `@pytest.mark. marker_name`<br><br>вместо `marker_name` указать `skip()`, то при запуске тестирования файла, функция с этим декораторам будет пропущена. Также можно указать `skip(reason=’R’)`, тогда в отчете о тестировании помимо того, что тест был пропущен будет указана также и причина пропуска R. <br><br>Если в декораторе вместо `marker_name` указать <br><br>`skipif(expr, reason=’R’)`, то при запуске тестирования файла, функция с этим декораторам будет пропущена в случае если expr будет True.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| xfail(), xfail(expr,reason)                               | Если в декораторе `@pytest.mark. marker_name `<br><br>вместо `marker_name` указать `xfail()`, то мы отметим тестовую функцию, как тест ожидающий сбоя. В таком случае в сводке тестирования статус выполнения тестовой функции изменится на х или XFAIL в случае, если тест вызовет ожидаемую ошибку. Если тест все же пройдет удачно, то статус будет X или XPASS. <br><br>`xfail(expr,reason)` – аналог `skipif`, но с результатом от `xfail()`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| parametrize(‘argname1, argname2’, [argvalue1, argvalue2]) | Если в декораторе `@pytest.mark. marker_name` <br><br>вместо marker_name указать `parametrize(‘argnames’, [argvalues])` то мы пропустим множество данных через один и тот же тест. Первый аргумент задает список имен, второй – список аргументов. pytest будет запускать этот тест один раз для каждой задачи и сообщать о каждом отдельном тесте. <br><br>Общий вид конструкции: <br><br>```python<br>@pytest.mark.parametrize(‘argname1, argname2’, [argvalue1, argvalue2])<br>def func(argname1, argname2): <br><br>      # ~argname1=>argvalue1[0]~ <br><br>      # ~argname2=>argvalue1[1]~ <br>```<br>Как видно argname позволяет присвоить имя элементам списков `argvalue` (а не самим `argvalue`). В случае если `argname` будет одно, то оно будет присвоено как стандартное для всех `argvalue`. <br><br>Каждый такой тест, называемый узлом можно осуществить отдельно, по имени: `pytest test_name.py::test_function[argname] `<br><br>Обязательно используйте кавычки, если в argname есть пробелы: `pytest “test_name.py::test_function[argname]”`<br><br>Вы также можете применить `parametrize()` к классам. При этом одни и те же наборы данных будут отправлены всем методам теста в классе. |

# Обработка исключений в процессе тестирования 

|                                                         |                                                                                                                                                                                                                                                                                                                 |
| ------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| with pytest.raises(Error): <br><br>     expr            | Конструкция позволяет проверить вывод ошибки (исключения) Error в выражении expr. Если исключение не вызывается, тест завершается неудачей. Если тест вызывает другое исключение, он завершается неудачей.                                                                                                      |
| with pytest.raises(Error) as excinfo: <br><br>     expr | Имя переменной после as (в данном случае excinfo) заполняется сведениями об исключении и имеет тип ExceptionInfo. Сообщение об исключении можно получить, например, следующим образом:  <br><br>`exception_msg = excinfo.value.args[0] `<br><br>`assert exception_msg == "db_type must be a 'tiny' or 'mongo'"` |

# Фикстуры 

Fixtures — это функции, выполняемые pytest до (а иногда и после) фактических тестовых функций. Код в фикстуре может делать все, что вам необходимо. Вы можете использовать Fixtures, чтобы получить набор данных для тестирования. Вы можете использовать Fixtures, чтобы получить систему в известном состоянии перед запуском теста. Fixtures также используются для получения данных для нескольких тестов. 

|                                                                                                             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ----------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| @pytest.fixture() <br><br>def func(): <br><br>       … <br><br>def func1(func): <br><br>       …            | Декоратор `@pytest.fixture()` используется, чтобы сообщить pytest, что функция является фикстурой. Когда вы включаете имя фикстуры в список параметров тестовой функции, pytest знает, как запустить её перед запуском теста. Фикстуры могут выполнять работу, а могут возвращать данные в тестовую функцию. <br><br>Наименование func значимо в pytest. pytest будет искать в модуле теста фикстуру с таким именем. Он также будет искать в файле conftest.py, если не найдет его в этом.                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| @pytest.fixture() <br><br>def func(): <br><br>       ‘setup’ <br><br>       yield <br><br>       ‘teardown’ | Функция fixture запускается перед тестами, которые ее используют. Однако, если в функции есть yield, то там произойдёт остановка, контроль передастся тестам и выполняется следующая за yield строка после завершения тестов.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| -- setup-show                                                                                               | Добавляет в сводку тестирования сведения об использованных фикстурах.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| --fixtures                                                                                                  | Флаг --fixtures выводит в сводку тестирования все фикстуры, доступные для теста, в том числе те, которые были переименованы.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| @pytest.fixture(scope='')                                                                                   | Фикстуры включают в себя необязательный параметр под названием scope, который определяет, как часто фикстура получает setup и teardown. <br><br>scope='function'<br><br>Выполняется один раз для каждой функции теста. Часть setup запускается перед каждым тестом с помощью fixture. Часть teardown запускается после каждого теста с использованием fixture. Это область, используемая по умолчанию, если параметр scope не указан. <br><br>scope='class' <br><br>Выполняется один раз для каждого тестового класса, независимо от количества тестовых методов в классе. <br><br>scope='module' <br><br>Выполняется один раз для каждого модуля, независимо от того, сколько тестовых функций или методов или других фикстур при использовании модуля. <br><br>scope='session' <br><br>Выполняется один раз за сеанс. Все методы и функции тестирования, использующие фикстуру области сеанса, используют один вызов setup и teardown. |
| @pytest.mark.usefixtures('fixture1', 'fixture2')                                                            | usefixtures принимает строку, состоящую из списка фикстур, разделенных запятыми. Это не особо имеет смысл делать с тестовыми функциями, но это хорошо работает для тестовых классов.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| @pytest.fixture(autouse=True)                                                                               | Параметр autouse позволяет использовать данные фикстуры не вначале и в конце теста, а постоянно. (Например, отсчет времени во время выполнения теста). <br><br>Поскольку фикстура является autouse, на неё не нужно ссылаться из теста.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| @pytest.fixture(name=???)                                                                                   | Параметр name позволяет изменить имя фикстуры в сводке тестирования.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| @pytest.fixture(params=(???)) <br><br>def func(request): <br><br>        ~request.param~                    | Параметр params позволяет параметризировать фикстуры. Тогда внутри функции фикстуры появляется атрибут param, который заполняется одним элементом из списка, назначенного params. Таким образом, тест использующий параметризированную фикстуру будет вызываться столько раз, сколько элементов содержит список params.  <br><br>Имя узла при этом будет совпадать с именем функции параметризированной фикстуры. <br><br>Параметр функции request обязателен.                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |

## Встроенные фикстуры 

|                                                                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| --------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| def func(tmpdir): <br><br>       …                              | Встроенная фикстура tmpdir используется для создания файлов или каталогов, используемых одним тестом (и только во время него – функциональная фикстура). <br><br>    # tmpdir уже имеет имя пути, связанное с ним join() расширяет путь, чтобы включить имя файла, создаваемого при записи в <br><br>    a_file = tmpdir.join('something.txt') <br><br>    # можете создавать каталоги <br><br>    a_sub_dir = tmpdir.mkdir('anything') <br><br>    # можете создавать файлы в директориях (создаются при записи) <br><br>    another_file = a_sub_dir.join('something_else.txt') <br><br>    # эта запись создает 'something.txt' <br><br>    a_file.write('contents may settle during shipping') <br><br>    # эта запись создает 'anything/something_else.txt' <br><br>    another_file.write('something different') <br><br>    # вы также можете прочитать файлы <br><br>    assert a_file.read() == 'contents may settle during shipping' <br><br>    assert another_file.read() == 'something different'                                                                                                                                                                                                                                                                                   |
| def func(tmpdir_factory): <br><br>       …                      | Встроенная фикстура tmpdir_factory используется, когда вы хотите настроить каталог для нескольких тестов (сеансовая фикстура). <br><br>    # вы должны начать с создания каталога. a_dir действует как объект, возвращенный из фикстуры tmpdir <br><br>    a_dir = tmpdir_factory.mktemp('mydir') <br><br>    # base_temp будет родительским каталогом 'mydir' (вам не нужно использовать getbasetemp(), чтобы показать, что он доступен) <br><br>    base_temp = tmpdir_factory.getbasetemp() <br><br>    print('base:', base_temp) <br><br>    # остальная часть этого теста выглядит так же, как в Примере ' test_tmpdir ()' <br><br>    a_file = a_dir.join('something.txt') <br><br>    a_sub_dir = a_dir.mkdir('anything') <br><br>    another_file = a_sub_dir.join('something_else.txt') <br><br>    a_file.write('contents may settle during shipping') <br><br>    another_file.write('something different') <br><br>    assert a_file.read() == 'contents may settle during shipping' <br><br>    assert another_file.read() == 'something different'                                                                                                                                                                                                                                  |
|                                                                 | Пример работы с различными файлами <br><br>@pytest.fixture(scope='module') <br><br>def author_file_json(tmpdir_factory): <br><br>    python_author_data = { <br><br>        'Ned': {'City': 'Boston'}, <br><br>        'Brian': {'City': 'Portland'}, <br><br>        'Luciano': {'City': 'San Paulo'} <br><br>    } <br><br>    file = tmpdir_factory.mktemp('data').join('author_file.json') <br><br>    with file.open('w') as f: <br><br>        json.dump(python_author_data, f) <br><br>    return file <br><br>def test_brian_in_portland(author_file_json): <br><br>    with author_file_json.open() as f: <br><br>        authors = json.load(f) <br><br>    assert authors['Brian']['City'] == 'Portland'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| def func(request,cache): <br><br>       …                       | Кэш фикстура позволяет сохранить данных в кэш-файлы или получить их. Интерфейс для кеш-фикстуры. <br><br>key = 'name/' + request.node.nodeid.replace(':', '_') <br><br>cache.get(key, default) <br><br>cache.set(key, value) <br><br>По соглашению, имена ключей начинаются с имени вашего приложения или плагина, за которым следует /, и продолжают разделять разделы имени ключа с /. Значение, которое вы храните, может быть любым, которое конвертируется в json, так как представлено в .cache directory. <br><br>Объект request используется для получения nodeid что бы использовать в ключе. nodeid — уникальный идентификатор, который работает даже с параметризованными тестами. <br><br>Идентификатор узла (nodeid) может иметь двоеточия. Поскольку ключи становятся именами файлов внутри .cache – меняем двоеточия на что-то безопасное в имени файла.                                                                                                                                                                                                                                                                                                                                                                                                                           |
|                                                                 | Пример сохранения в кэш времени тестирования <br><br>@pytest.fixture(autouse=True) <br><br>def check_duration(request, cache): <br><br>    key = 'duration/' + request.node.nodeid.replace(':', '_') <br><br>    start_time = datetime.datetime.now() <br><br>    yield <br><br>    stop_time = datetime.datetime.now() <br><br>    this_duration = (stop_time - start_time).total_seconds() <br><br>    last_duration = cache.get(key, None) <br><br>    cache.set(key, this_duration) <br><br>    if last_duration is not None: <br><br>        errorstring = "длительность теста превышает последний боле чем в 2-а раза " <br><br>        assert this_duration <= last_duration * 2, errorstring                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| def func(capsys): <br><br>       out, err = capsys.readouterr() | Фикстура capsys обеспечивает две функциональные возможности: позволяет получить stdout и stderr из некоторого кода, и временно отключить захват вывода. <br><br>Захваченные stdout и stderr извлекаются из capsys.redouterr(). Возвращаемое значение – это то, что было зафиксировано с начала функции, или с момента последнего вызова (out – сообщения, выводимые в печать, err – сообщения об ошибках). <br><br>pytest обычно захватывает выходные данные тестов и тестируемого кода. В том числе инструкции print. Захваченный вывод отображается для отказов тестов только после завершения полного тестового сеанса. Параметр -s отключает эту функцию, и выходные данные отправляются в stdout во время выполнения тестов. Тем не менее, вы можете позволить каким-то выходным данным сделать его через захват вывода pytest по умолчанию, чтобы напечатать отдельные вещи, не печатая все. Вы можете сделать это с capsys.  <br><br>Вы можете использовать capsys.disabled(), чтобы временно пропустить вывод через механизм захвата, например: <br><br>def test_capsys_disabled(capsys): <br><br>    with capsys.disabled(): <br><br>        print('\nalways print this') # всегда будет выводиться в сводку <br><br>    print('normal print, usually captured') # только после флага -s |
|                                                                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
|                                                                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
|                                                                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |

# Hook-функции 

hook-функции изменяют поведение pytest непосредственно в процессе тестирования. Поскольку pytest был разработан с целью позволить плагинам слегка менять поведение pytest, доступно множество hook-функций. hook-и для pytest указаны на сайте документации pytest. 

|   |   |
|---|---|
|pytest_report_header()|Позволяет вывести сообщение в начало сводки тестирования. <br><br>Конструкция: <br><br>def pytest_report_header(): <br><br>    return "message" <br><br>Можно, например, добавить имя пользователя, указать используемое оборудование и тестируемые версии.|
|pytest_report_teststatus(report)|Позволяет изменить отчет о состоянии теста: сокращенное сообщение и развернутое. <br><br>Конструкция: <br><br>def pytest_report_teststatus(report): <br><br>    if report.when == 'call' and report.failed: <br><br>            return (report.outcome, 's', 'status') <br><br>‘s’ будет выводиться в обычной сводке. <br><br>'status' – в развернутой (с флагом -v).|
|pytest_addoption(parser)|Позволяет добавить пользовательский флаг с настраиваемым функционалом. <br><br>Конструкция: <br><br>def pytest_addoption(parser): <br><br>    group = parser.getgroup('flag_group') <br><br>    group.addoption("--flag", action="store_true", <br><br>                    help="help_information") <br><br>'flag_group' – ключевое слово для добавления функций к опции, <br><br>--flag – пользовательский флаг, указываемый в командной строке, <br><br>action – действие, которое выполняет флаг (в данном случае, переключает булеву переменную). <br><br>Тогда функции, добавляемые к флагу, будут иметь условие: <br><br>def pytest_report_header(config): <br><br>    if config.getoption('flag_group'): <br><br>        return "message"|
